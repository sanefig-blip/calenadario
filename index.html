<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shifter - Calendario de Turnos</title>
    <!-- Tailwind CSS - Proporciona todos los estilos de la aplicación -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuración para habilitar el modo oscuro de Tailwind
        tailwind.config = {
          darkMode: 'class',
          theme: {
            extend: {
              spacing: {
                '128': '32rem',
              }
            }
          }
        }
    </script>
    <!-- Estilos generales y un pequeño cargador inicial -->
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: sans-serif;
            font-size: 1.5rem;
            color: #4a5568;
            background-color: #f8fafc;
        }
        .dark #loader {
            color: #cbd5e1;
            background-color: #030712;
        }
        .tab-scroll-container {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .tab-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950">
    <!-- El div principal donde se montará la aplicación de React -->
    <div id="root">
        <div id="loader">Cargando...</div>
    </div>

    <!-- Librerías de Javascript necesarias para que la aplicación funcione -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 
      El corazón de la aplicación.
      Todo el código de React (componentes, lógica, etc.) está aquí.
      Babel lo transforma en Javascript que el navegador puede entender.
    -->
    <script type="text/babel" data-presets="react">
// --- INICIO: React y utilidades ---
const { useState, useEffect, useCallback, useMemo, useRef } = React;

const uid = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

const getDayKey = (date) => {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
};
// --- FIN: React y utilidades ---


// --- INICIO: Constantes ---
const INITIAL_PEOPLE = [
    { id: 'de_carli', name: 'Ayte De Carli', color: 'bg-emerald-200', textColor: 'text-emerald-800' },
    { id: 'gomez', name: 'Insp GOMEZ', color: 'bg-orange-200', textColor: 'text-orange-800' },
    { id: 'reichel', name: 'Ayte REICHEL', color: 'bg-amber-200', textColor: 'text-amber-800' },
    { id: 'peritos', name: 'Peritos', color: 'bg-yellow-400', textColor: 'text-yellow-900' },
    { id: 'gdia_mic', name: 'Gdia mic', color: 'bg-purple-300', textColor: 'text-purple-900' },
    { id: 'morgu', name: 'Morgu', color: 'bg-yellow-300', textColor: 'text-yellow-900' },
    { id: 'gdia_t1_d', name: 'Gdia T1 d', color: 'bg-indigo-300', textColor: 'text-indigo-900' },
    { id: 'denver', name: 'DENVER', color: 'bg-sky-300', textColor: 'text-sky-900' },
    { id: 'cuerpo', name: 'Cuerpo', color: 'bg-amber-300', textColor: 'text-amber-900' },
    { id: 'gt1_dia_e', name: 'GT1 dia e', color: 'bg-rose-300', textColor: 'text-rose-900' },
    { id: 'ano_nuev', name: 'Año Nuev', color: 'bg-cyan-300', textColor: 'text-cyan-900' },
    { id: 'dia_del_p', name: 'Día del Pe', color: 'bg-lime-300', textColor: 'text-lime-900' },
    { id: 'paseo_col', name: 'paseo col', color: 'bg-orange-300', textColor: 'text-orange-900' },
    { id: 'listado', name: 'Listado', color: 'bg-gray-300', textColor: 'text-gray-900' },
];

const COLOR_PALETTE = [
    { color: 'bg-red-500', textColor: 'text-white' }, { color: 'bg-orange-500', textColor: 'text-white' },
    { color: 'bg-amber-500', textColor: 'text-white' }, { color: 'bg-yellow-400', textColor: 'text-gray-800' },
    { color: 'bg-lime-500', textColor: 'text-gray-800' }, { color: 'bg-green-500', textColor: 'text-white' },
    { color: 'bg-emerald-500', textColor: 'text-white' }, { color: 'bg-teal-500', textColor: 'text-white' },
    { color: 'bg-cyan-500', textColor: 'text-white' }, { color: 'bg-sky-500', textColor: 'text-white' },
    { color: 'bg-blue-500', textColor: 'text-white' }, { color: 'bg-indigo-500', textColor: 'text-white' },
    { color: 'bg-purple-500', textColor: 'text-white' }, { color: 'bg-fuchsia-500', textColor: 'text-white' },
    { color: 'bg-pink-500', textColor: 'text-white' }, { color: 'bg-rose-500', textColor: 'text-white' },
];

const DAYS_OF_WEEK_SHORT = ['LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB', 'DOM'];
const MONTH_NAMES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

const PRINCIPAL_SCHEDULE_DATA = {
  '2025-08-31': [{ id: uid(), personId: 'peritos' }], '2025-09-01': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'morgu' }], '2025-09-02': [{ id: uid(), personId: 'gdia_t1_d' }],
  '2025-09-03': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'gdia_mic' }], '2025-09-04': [{ id: uid(), personId: 'cuerpo' }], '2025-09-05': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'gt1_dia_e' }],
  '2025-09-07': [{ id: uid(), personId: 'gdia_mic' }], '2025-09-08': [{ id: uid(), personId: 'gt1_dia_e' }], '2025-09-09': [{ id: uid(), personId: 'gdia_mic' }], '2025-09-10': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'cuerpo' }],
  '2025-09-11': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'gt1_dia_e' }, { id: uid(), personId: 'paseo_col' }], '2025-09-12': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'paseo_col' }],
  '2025-09-13': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'cuerpo' }], '2025-09-14': [{ id: uid(), personId: 'gt1_dia_e' }, { id: uid(), personId: 'gdia_mic' }], '2025-09-15': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'morgu' }],
  '2025-09-16': [{ id: uid(), personId: 'cuerpo' }, { id: uid(), personId: 'paseo_col' }], '2025-09-17': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'gt1_dia_e' }],
  '2025-09-18': [{ id: uid(), personId: 'morgu' }, { id: uid(), personId: 'paseo_col' }], '2025-09-19': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'cuerpo' }],
  '2025-09-20': [{ id: uid(), personId: 'gt1_dia_e' }, { id: uid(), personId: 'paseo_col' }], '2025-09-21': [{ id: uid(), personId: 'gdia_mic' }], '2025-09-22': [{ id: uid(), personId: 'ano_nuev' }, { id: uid(), personId: 'paseo_col' }],
  '2025-09-23': [{ id: uid(), personId: 'ano_nuev' }, { id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'gt1_dia_e' }], '2025-09-24': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'ano_nuev' }, { id: uid(), personId: 'paseo_col' }],
  '2025-09-25': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'cuerpo' }], '2025-09-26': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'gt1_dia_e' }], '2025-09-27': [{ id: uid(), personId: 'gdia_mic' }],
  '2025-09-28': [{ id: uid(), personId: 'cuerpo' }, { id: uid(), personId: 'paseo_col' }], '2025-09-29': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'gt1_dia_e' }, { id: uid(), personId: 'paseo_col' }],
  '2025-10-01': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'dia_del_p' }, { id: uid(), personId: 'gdia_mic' }], '2025-10-02': [{ id: uid(), personId: 'dia_del_p' }, { id: uid(), personId: 'gt1_dia_e' }],
  '2025-10-03': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'gdia_mic' }], '2025-10-05': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'gt1_dia_e' }], '2025-10-07': [{ id: uid(), personId: 'gdia_mic' }],
  '2025-10-08': [{ id: uid(), personId: 'denver' }, { id: uid(), personId: 'gt1_dia_e' }], '2025-10-09': [{ id: uid(), personId: 'gdia_mic' }], '2025-10-10': [{ id: uid(), personId: 'denver' }], '2025-10-11': [{ id: uid(), personId: 'gdia_mic' }, { id: uid(), personId: 'gt1_dia_e' }],
};

const PASEO_COLON_SCHEDULE = {
  '2025-09-01': [{ id: uid(), personId: 'de_carli' }], '2025-09-02': [{ id: uid(), personId: 'gomez' }], '2025-09-03': [{ id: uid(), personId: 'de_carli' }],
  '2025-09-05': [{ id: uid(), personId: 'de_carli' }], '2025-09-06': [{ id: uid(), personId: 'reichel' }], '2025-09-07': [{ id: uid(), personId: 'de_carli' }],
  '2025-09-08': [{ id: uid(), personId: 'gomez' }], '2025-09-09': [{ id: uid(), personId: 'de_carli' }], '2025-09-10': [{ id: uid(), personId: 'gomez' }],
  '2025-09-11': [{ id: uid(), personId: 'de_carli' }], '2025-09-12': [{ id: uid(), personId: 'gomez' }], '2025-09-13': [{ id: uid(), personId: 'de_carli' }],
  '2025-09-14': [{ id: uid(), personId: 'reichel' }], '2025-09-15': [{ id: uid(), personId: 'de_carli' }], '2025-09-16': [{ id: uid(), personId: 'gomez' }],
  '2025-09-17': [{ id: uid(), personId: 'de_carli' }], '2025-09-18': [{ id: uid(), personId: 'gomez' }], '2025-09-19': [{ id: uid(), personId: 'de_carli' }],
  '2025-09-20': [{ id: uid(), personId: 'gomez' }], '2025-09-21': [{ id: uid(), personId: 'reichel' }], '2025-09-22': [{ id: uid(), personId: 'gomez' }],
  '2025-09-23': [{ id: uid(), personId: 'de_carli' }], '2025-09-24': [{ id: uid(), personId: 'gomez' }], '2025-09-25': [{ id: uid(), personId: 'de_carli' }],
  '2025-09-26': [{ id: uid(), personId: 'gomez' }], '2025-09-27': [{ id: uid(), personId: 'de_carli' }], '2025-09-28': [{ id: uid(), personId: 'gomez' }],
  '2025-09-29': [{ id: uid(), personId: 'de_carli' }], '2025-09-30': [{ id: uid(), personId: 'gomez' }],
};

const GENERAL_CALENDAR_ID = 'general';
// --- FIN: Constantes ---


// --- INICIO: Iconos ---
const CalendarIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>);
const PencilIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/><path d="m15 5 4 4"/></svg>);
const AlertTriangleIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>);
const ChevronLeftIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>);
const ChevronRightIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>);
const XIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
const TrashIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
const CheckIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>);
const SearchIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>);
const ChevronDownIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>);
const PlusIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
const SunIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>);
const MoonIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>);
const BroomIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 8L8 20"/><path d="M21 15a2 2 0 0 1-2 2H7l-4 4"/><path d="M15 3a2 2 0 0 0-2 2l-3.4 3.4"/><path d="M18 6L9 15"/></svg>);
const CogIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="m17 7 1.4-1.4"/><path d="m6.4 17.6 1.4-1.4"/><path d="M7 7l-1.4-1.4"/><path d="m17.6 17.6-1.4-1.4"/><path d="M2 12h2"/><path d="M22 12h-2"/><path d="m17 17 1.4 1.4"/><path d="m6.4 6.4 1.4 1.4"/></svg>);
const SpinnerIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>);
const CameraIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>);
// --- FIN: Iconos ---


// --- INICIO: Hook Personalizado ---
const useLocalStorage = (key, initialValue) => {
    const [storedValue, setStoredValue] = useState(() => {
        try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
        } catch (error) {
            console.error(error);
            return initialValue;
        }
    });

    const setValue = (value) => {
        try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {
            console.error(error);
        }
    };
    return [storedValue, setValue];
};
// --- FIN: Hook Personalizado ---


// --- INICIO: Componentes ---

const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, children, confirmText = 'Confirmar', confirmButtonClass = 'bg-red-600 hover:bg-red-700 focus:ring-red-500' }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex justify-center items-center z-50 p-4" onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="confirmation-title">
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                <div className="p-6 text-center">
                    <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50 mb-4">
                        <AlertTriangleIcon className="h-6 w-6 text-red-600 dark:text-red-400" aria-hidden="true" />
                    </div>
                    <h3 id="confirmation-title" className="text-lg font-bold text-gray-900 dark:text-white mb-2">{title}</h3>
                    <div className="text-sm text-gray-600 dark:text-gray-300">{children}</div>
                </div>
                <div className="bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 flex flex-row-reverse rounded-b-lg">
                    <button onClick={onConfirm} type="button" className={`w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 sm:ml-3 sm:w-auto sm:text-sm ${confirmButtonClass}`}>{confirmText}</button>
                    <button onClick={onClose} type="button" className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-900 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button>
                </div>
            </div>
        </div>
    );
};

const PeopleManagementModal = ({ isOpen, onClose, people, onAdd, onUpdate, onDelete }) => {
    if (!isOpen) return null;

    const PersonListItem = ({ person, onUpdate, onDelete }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [name, setName] = useState(person.name);
        const [selectedColor, setSelectedColor] = useState({ color: person.color, textColor: person.textColor });

        const handleSave = () => {
            if (name.trim()) {
                onUpdate({ ...person, name: name.trim(), color: selectedColor.color, textColor: selectedColor.textColor });
                setIsEditing(false);
            } else { alert("El nombre no puede estar vacío."); }
        };
        const handleCancel = () => {
            setName(person.name);
            setSelectedColor({ color: person.color, textColor: person.textColor });
            setIsEditing(false);
        };

        if (isEditing) {
            return (
                <div className="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg space-y-3 shadow-md">
                    <div>
                        <label className="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Nombre</label>
                        <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-800 text-sm" autoFocus />
                    </div>
                    <div>
                        <label className="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Color</label>
                        <div className="flex flex-wrap gap-2">
                            {COLOR_PALETTE.map((c, i) => ( <button key={i} onClick={() => setSelectedColor(c)} className={`w-7 h-7 rounded-full ${c.color} transition-transform transform hover:scale-110 ${selectedColor.color === c.color ? 'ring-2 ring-blue-500 ring-offset-2 dark:ring-offset-gray-700' : ''}`} aria-label={`Color ${c.color}`} /> ))}
                        </div>
                    </div>
                    <div className="flex justify-end space-x-2 pt-2">
                        <button onClick={handleCancel} className="px-3 py-1 rounded-md text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold">Cancelar</button>
                        <button onClick={handleSave} className="px-3 py-1 rounded-md text-sm bg-blue-600 text-white hover:bg-blue-700 flex items-center font-semibold"><CheckIcon className="w-4 h-4 mr-1" /> Guardar</button>
                    </div>
                </div>
            );
        }

        return (
            <div className="flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg transition-colors group">
                <span className={`w-4 h-4 rounded-full mr-3 flex-shrink-0 ${person.color}`}></span>
                <span className="flex-grow font-medium truncate" title={person.name}>{person.name}</span>
                <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onClick={() => setIsEditing(true)} className="p-1.5 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" aria-label={`Editar ${person.name}`}><PencilIcon className="w-4 h-4" /></button>
                    <button onClick={() => onDelete(person)} className="p-1.5 text-gray-500 hover:text-red-600 dark:hover:text-red-400 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" aria-label={`Borrar ${person.name}`}><TrashIcon className="w-4 h-4" /></button>
                </div>
            </div>
        );
    };

    const AddPersonForm = ({ onAdd }) => {
        const [name, setName] = useState('');
        const [selectedColor, setSelectedColor] = useState(COLOR_PALETTE[0]);
        const handleSubmit = (e) => {
            e.preventDefault();
            if (!name.trim()) { alert('El nombre no puede estar vacío.'); return; }
            onAdd({ name: name.trim(), color: selectedColor.color, textColor: selectedColor.textColor });
            setName('');
            setSelectedColor(COLOR_PALETTE[0]);
        };
        return (
            <form onSubmit={handleSubmit} className="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg mt-4">
                <h3 className="text-md font-bold text-gray-800 dark:text-gray-100 mb-3">Añadir Persona/Evento</h3>
                <div className="space-y-3">
                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Nuevo nombre" className="w-full p-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-900" />
                    <div className="flex flex-wrap gap-2">
                        {COLOR_PALETTE.map((c, i) => ( <button key={i} type="button" onClick={() => setSelectedColor(c)} className={`w-7 h-7 rounded-full ${c.color} transition-transform transform hover:scale-110 ${selectedColor.color === c.color ? 'ring-2 ring-blue-500 ring-offset-2 dark:ring-offset-gray-900' : ''}`} aria-label={`Seleccionar color ${c.color}`} /> ))}
                    </div>
                    <button type="submit" className="w-full flex items-center justify-center px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 font-semibold"><PlusIcon className="w-5 h-5 mr-1" /> Añadir</button>
                </div>
            </form>
        );
    }

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex justify-center items-center z-50 p-4" onClick={onClose} role="dialog" aria-modal="true">
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                    <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100">Gestionar Personas/Eventos</h2>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300" aria-label="Cerrar"><XIcon className="w-6 h-6"/></button>
                </div>
                <div className="p-4 max-h-[60vh] overflow-y-auto">
                    <div className="space-y-1">{people.map(person => ( <PersonListItem key={person.id} person={person} onUpdate={onUpdate} onDelete={onDelete} /> ))}</div>
                </div>
                <div className="px-4 pb-4"><AddPersonForm onAdd={onAdd} /></div>
            </div>
        </div>
    );
};

const AssignmentModal = ({ isOpen, onClose, date, assignments, onSave, people, personIdToFocus, calendarName }) => {
    const [currentAssignments, setCurrentAssignments] = useState([]);
    const [newPersonId, setNewPersonId] = useState('');

    useEffect(() => {
        if (isOpen) {
            setCurrentAssignments(assignments);
            setNewPersonId(people[0]?.id || '');
        }
    }, [isOpen, assignments, people]);

    if (!isOpen || !date) return null;

    const dateKey = getDayKey(date);
    const formattedDate = new Intl.DateTimeFormat('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).format(date);

    const handleAddAssignment = (e) => {
        e.preventDefault();
        if (!newPersonId) { alert('Por favor, seleccione una persona/tarea.'); return; }
        const newAssignment = { id: uid(), personId: newPersonId };
        const updatedAssignments = [...currentAssignments, newAssignment];
        setCurrentAssignments(updatedAssignments);
        onSave(dateKey, updatedAssignments);
    };

    const handleDeleteAssignment = (assignmentId) => {
        const updatedAssignments = currentAssignments.filter(a => a.id !== assignmentId);
        setCurrentAssignments(updatedAssignments);
        onSave(dateKey, updatedAssignments);
    };

    const getPerson = (personId) => people.find(p => p.id === personId);
    
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex justify-center items-center z-50 p-4" onClick={onClose} role="dialog" aria-modal="true">
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                    <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100">Editar Turnos ({calendarName})</h2>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300" aria-label="Cerrar"><XIcon className="w-6 h-6"/></button>
                </div>
                <div className="p-4 max-h-[80vh] overflow-y-auto">
                    <p className="text-gray-600 dark:text-gray-300 mb-4 font-semibold">{formattedDate}</p>
                    <form onSubmit={handleAddAssignment} className="space-y-3 bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-4">
                        <h3 className="font-bold text-gray-700 dark:text-gray-200">Añadir Nuevo Turno</h3>
                        <div>
                            <label htmlFor="person" className="block text-sm font-medium text-gray-700 dark:text-gray-300">Tarea / Persona</label>
                            <select id="person" value={newPersonId} onChange={e => setNewPersonId(e.target.value)} className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                {people.map(person => <option key={person.id} value={person.id}>{person.name}</option>)}
                            </select>
                        </div>
                        <button type="submit" className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold">Añadir</button>
                    </form>
                    <div className="space-y-2">
                        <h3 className="font-bold text-gray-700 dark:text-gray-200 mt-4">Turnos Asignados</h3>
                        {currentAssignments.length > 0 ? currentAssignments.map(assignment => {
                            const person = getPerson(assignment.personId);
                            if (!person) return null;
                            const isFocused = personIdToFocus === assignment.personId;
                            return (
                                <div key={assignment.id} className={`flex items-center justify-between p-2 rounded-md ${person.color} ${person.textColor} ${isFocused ? 'ring-2 ring-blue-500 ring-offset-2 dark:ring-offset-gray-800' : ''}`}>
                                    <p className={`font-bold`}>{person.name}</p>
                                    <button onClick={() => handleDeleteAssignment(assignment.id)} className={`p-1 rounded-full hover:bg-black hover:bg-opacity-20`} aria-label={`Eliminar turno de ${person.name}`}><TrashIcon className="w-5 h-5"/></button>
                                </div>
                            );
                        }) : (<p className="text-gray-500 dark:text-gray-400 text-center py-4">No hay turnos para este día.</p>)}
                    </div>
                </div>
            </div>
        </div>
    );
};

const Header = ({ currentDate, theme, onToggleTheme, onPrevMonth, onNextMonth, onGoToToday, onOpenPeopleManager, onClearData, onCapture, isCapturing }) => {
    const monthName = MONTH_NAMES[currentDate.getMonth()];
    const year = currentDate.getFullYear();

    return (
        <header className="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-sm dark:shadow-gray-900/50 p-3 sticky top-0 z-20 transition-colors duration-300">
            <div className="container mx-auto flex items-center justify-between">
                <div className="flex items-center space-x-2 md:space-x-4">
                    <button onClick={onOpenPeopleManager} className="p-1 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" aria-label="Gestionar personas"><CogIcon className="w-6 h-6" /></button>
                    <button onClick={onGoToToday} className="px-4 py-1.5 rounded-md border border-gray-300 dark:border-gray-600 text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">Hoy</button>
                    <div className="flex items-center">
                        <button onClick={onPrevMonth} className="p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" aria-label="Mes anterior"><ChevronLeftIcon className="w-5 h-5" /></button>
                        <div className="text-center mx-1 md:mx-2" style={{ minWidth: '180px' }}><h1 className="text-xl md:text-2xl font-semibold">{`${monthName} ${year}`}</h1></div>
                        <button onClick={onNextMonth} className="p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" aria-label="Mes siguiente"><ChevronRightIcon className="w-5 h-5" /></button>
                    </div>
                </div>
                <div className="flex items-center space-x-1 md:space-x-2">
                    <button onClick={onCapture} disabled={isCapturing} className="p-2 rounded-full hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-wait" aria-label="Capturar imagen">
                        {isCapturing ? <SpinnerIcon className="w-5 h-5 animate-spin text-blue-500" /> : <CameraIcon className="w-5 h-5 text-gray-600 dark:text-gray-300" />}
                    </button>
                    <button onClick={onToggleTheme} className="p-2 rounded-full hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors" aria-label="Cambiar tema">
                        {theme === 'light' ? <MoonIcon className="w-5 h-5 text-gray-600" /> : <SunIcon className="w-5 h-5 text-yellow-300" />}
                    </button>
                    <button onClick={onClearData} className="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" aria-label="Borrar todos los datos"><BroomIcon className="w-5 h-5 text-red-500 dark:text-red-400"/></button>
                </div>
            </div>
        </header>
    );
};

const Tabs = ({ calendars, activeCalendarId, onSelectTab, onAddTab, onRenameTab, onDeleteTab }) => {
    const [editingTabId, setEditingTabId] = useState(null);
    const [editingName, setEditingName] = useState('');
    const inputRef = useRef(null);

    useEffect(() => {
        if (editingTabId && inputRef.current) {
            inputRef.current.focus();
        }
    }, [editingTabId]);

    const handleStartEditing = (calendar) => {
        setEditingTabId(calendar.id);
        setEditingName(calendar.name);
    };

    const handleNameChange = (e) => setEditingName(e.target.value);
    
    const handleSave = (id) => {
        if (editingName.trim()) {
            onRenameTab(id, editingName.trim());
        }
        setEditingTabId(null);
    };

    const handleKeyDown = (e, id) => {
        if (e.key === 'Enter') handleSave(id);
        if (e.key === 'Escape') setEditingTabId(null);
    };
    
    const tabs = [{id: GENERAL_CALENDAR_ID, name: 'General'}, ...Object.values(calendars)];

    return (
        <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-[73px] z-10">
            <div className="container mx-auto px-2 flex items-center space-x-2 tab-scroll-container overflow-x-auto">
                {tabs.map(cal => {
                    const isActive = cal.id === activeCalendarId;
                    const isEditing = editingTabId === cal.id;
                    const isGeneral = cal.id === GENERAL_CALENDAR_ID;

                    const paddingClasses = isGeneral ? 'px-3' : 'pl-3 pr-12';
                    const activeClasses = isActive 
                        ? 'border-blue-600 text-blue-600 dark:text-blue-400' 
                        : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600';

                    return (
                        <div key={cal.id} className={`relative flex items-center group whitespace-nowrap border-b-2 py-2 text-sm font-medium transition-colors ${activeClasses} ${paddingClasses}`}>
                            {isEditing ? (
                                <input 
                                    ref={inputRef} 
                                    type="text" 
                                    value={editingName} 
                                    onChange={handleNameChange} 
                                    onBlur={() => handleSave(cal.id)} 
                                    onKeyDown={(e) => handleKeyDown(e, cal.id)} 
                                    className="bg-gray-100 dark:bg-gray-700 border border-blue-500 rounded px-2 py-0.5 text-sm font-medium w-full text-gray-800 dark:text-gray-200"
                                />
                            ) : (
                                <button onClick={() => onSelectTab(cal.id)} className="truncate max-w-[150px]">
                                    {cal.name}
                                </button>
                            )}
                            {!isGeneral && !isEditing && (
                                <div className="absolute right-2 top-1/2 -translate-y-1/2 flex items-center opacity-0 group-hover:opacity-100 transition-opacity space-x-1">
                                    <button onClick={() => handleStartEditing(cal)} className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                        <PencilIcon className="w-4 h-4 text-gray-500 dark:text-gray-400"/>
                                    </button>
                                    <button onClick={() => onDeleteTab(cal.id)} className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                        <XIcon className="w-4 h-4 text-gray-500 dark:text-gray-400"/>
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                })}
                <button onClick={onAddTab} className="flex items-center justify-center w-8 h-8 rounded-md text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex-shrink-0"><PlusIcon className="w-5 h-5"/></button>
            </div>
        </div>
    );
};

const ViewSwitcher = ({ activeView, onSwitch }) => {
    return (
        <div className="bg-gray-50 dark:bg-gray-950 pt-3 sticky top-[117px] z-10">
            <div className="container mx-auto px-4">
                <div className="inline-flex rounded-md shadow-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                    <button
                        onClick={() => onSwitch('calendar')}
                        className={`px-4 py-2 text-sm font-medium rounded-l-md transition-colors ${activeView === 'calendar' ? 'bg-blue-600 text-white' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}
                    >
                        Calendario
                    </button>
                    <button
                        onClick={() => onSwitch('summary')}
                        className={`px-4 py-2 text-sm font-medium rounded-r-md border-l border-gray-200 dark:border-gray-700 transition-colors ${activeView === 'summary' ? 'bg-blue-600 text-white' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}
                    >
                        Resumen
                    </button>
                </div>
            </div>
        </div>
    );
};

const CalendarGrid = ({ currentDate, schedule, people, onDayClick, addModePersonId, activeCalendarId, calendarName }) => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDayOfMonth = new Date(year, month, 1);
    const lastDayOfMonth = new Date(year, month + 1, 0);
    const daysInMonth = lastDayOfMonth.getDate();
    const startDayOfWeek = firstDayOfMonth.getDay();
    const dayOffset = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;

    const calendarDays = [];
    const prevMonthLastDay = new Date(year, month, 0);
    for (let i = dayOffset; i > 0; i--) calendarDays.push(new Date(year, month - 1, prevMonthLastDay.getDate() - i + 1));
    for (let i = 1; i <= daysInMonth; i++) calendarDays.push(new Date(year, month, i));
    let i = 1;
    while (calendarDays.length < 42) calendarDays.push(new Date(year, month + 1, i++));

    const Day = ({ day }) => {
        const dayKey = getDayKey(day);
        const isCurrentMonth = day.getMonth() === month;
        const assignments = schedule[dayKey] || [];
        const today = new Date();
        const isToday = day.getDate() === today.getDate() && day.getMonth() === today.getMonth() && day.getFullYear() === today.getFullYear();
        const dayNumberColor = isCurrentMonth ? 'text-gray-800 dark:text-gray-200' : 'text-gray-400 dark:text-gray-500';
        const isGeneralView = activeCalendarId === GENERAL_CALENDAR_ID;
        const isDisabled = isGeneralView;
        
        const containerClasses = [
            'relative flex flex-col min-h-[8rem] p-1.5 border-t border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 transition-colors duration-200',
            (addModePersonId && !isDisabled) ? 'cursor-copy hover:bg-green-50 dark:hover:bg-green-900/50' : 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800',
            isDisabled ? 'cursor-not-allowed bg-gray-50 dark:bg-gray-900/50' : ''
        ].join(' ');

        return (
            <div onClick={() => !isDisabled && onDayClick(day)} className={containerClasses}>
                <div className={`flex items-center justify-center w-7 h-7 text-sm font-medium rounded-full ${isToday ? 'bg-blue-600 text-white' : dayNumberColor}`}>{day.getDate()}</div>
                <div className="flex-grow mt-1 space-y-1 overflow-y-auto">
                    {assignments.map(a => {
                        const person = people.find(p => p.id === a.personId);
                        if (!person) return null;
                        return (
                            <div key={a.id} className={`px-1.5 py-0.5 rounded text-xs font-semibold whitespace-normal break-words ${person.color} ${person.textColor}`}>
                                {isGeneralView && a.calendarName ? `[${a.calendarName.substring(0,3)}] ${person.name}` : person.name}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    };

    return (
        <div className="bg-gray-50 dark:bg-gray-950 border-l border-b border-gray-200 dark:border-gray-700">
            <div className="grid grid-cols-7 text-center font-bold text-gray-500 dark:text-gray-400 text-sm">
                {DAYS_OF_WEEK_SHORT.map((day, index) => <div key={index} className="py-2 border-t border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">{day}</div>)}
            </div>
            <div className="grid grid-cols-7">{calendarDays.map((day, index) => <Day key={index} day={day} />)}</div>
        </div>
    );
};

const SummaryView = ({ schedule, people, currentDate, onDayClick, addModePersonId, onToggleAddMode, activeCalendarId }) => {
    const month = currentDate.getMonth();
    const year = currentDate.getFullYear();
    const summary = {};
    people.forEach(p => { summary[p.id] = []; });

    Object.keys(schedule).forEach(dateKey => {
        const parts = dateKey.split('-').map(p => parseInt(p, 10));
        const date = new Date(parts[0], parts[1] - 1, parts[2]);
        if (date.getMonth() === month && date.getFullYear() === year) {
            schedule[dateKey].forEach(assignment => {
                if (summary[assignment.personId]) summary[assignment.personId].push(date.getDate());
            });
        }
    });

    const getPerson = (personId) => people.find(p => p.id === personId);
    const sortedPeopleIds = Object.keys(summary).sort((a, b) => getPerson(a)?.name.localeCompare(getPerson(b)?.name));
    const isGeneralView = activeCalendarId === GENERAL_CALENDAR_ID;

    return (
        <div className="p-4 bg-white dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 my-4">
            <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Resumen del Mes</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {sortedPeopleIds.map(personId => {
                    const person = getPerson(personId);
                    if (!person) return null;
                    const days = [...new Set(summary[personId])].sort((a, b) => a - b);
                    const isAddModeActive = addModePersonId === person.id;
                    return (
                        <div key={person.id} className="bg-gray-50 dark:bg-gray-800 p-3 rounded-md">
                            <div className="flex items-center mb-2 gap-2">
                                <button onClick={() => onToggleAddMode(person.id)} disabled={isGeneralView} className={`p-1.5 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${isAddModeActive ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-green-500 text-white hover:bg-green-600'}`} aria-label={isAddModeActive ? `Cancelar` : `Añadir turno`}>
                                    {isAddModeActive ? <XIcon className="w-3 h-3" /> : <PlusIcon className="w-3 h-3" />}
                                </button>
                                <span className={`w-3 h-3 rounded-full ${person.color}`}></span>
                                <h3 className="font-bold text-sm text-gray-800 dark:text-gray-200 truncate flex-grow">{person.name}</h3>
                                <span className="text-xs font-semibold text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">{days.length} días</span>
                            </div>
                            {days.length > 0 ? (
                                <div className="flex flex-wrap gap-1.5 pt-1">
                                    {days.map(day => <button key={day} onClick={() => !isGeneralView && onDayClick(new Date(year, month, day), person.id)} className={`w-7 h-7 flex items-center justify-center text-xs font-bold rounded-md bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 transition-all duration-200 ${!isGeneralView && 'hover:bg-blue-500 hover:text-white dark:hover:bg-blue-500'}`} >{day}</button>)}
                                </div>
                            ) : (<p className="text-sm text-gray-400 dark:text-gray-500 italic">Sin turnos</p>)}
                        </div>
                    );
                })}
            </div>
        </div>
    );
};
// --- FIN: Componentes ---

// --- INICIO: Pantalla de Login ---
const LoginScreen = ({ onLogin }) => {
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const passwordRef = useRef(null);

    useEffect(() => {
        passwordRef.current?.focus();
    }, []);

    const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        setTimeout(() => {
            if (password === 'mica2025') {
                onLogin();
            } else {
                setError('Contraseña incorrecta.');
                setPassword('');
                setIsLoading(false);
                passwordRef.current?.focus();
            }
        }, 500);
    };

    return (
        <div className="fixed inset-0 bg-gray-50 dark:bg-gray-950 flex items-center justify-center p-4">
            <div className="w-full max-w-sm mx-auto p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
                <div className="text-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Calendario</h1>
                    <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">Introduce la contraseña para acceder.</p>
                </div>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="password-input" className="sr-only">Contraseña</label>
                        <input
                            ref={passwordRef}
                            id="password-input"
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            placeholder="Contraseña"
                            required
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                        />
                    </div>
                    {error && <p className="text-xs text-red-500 text-center">{error}</p>}
                    <div>
                        <button type="submit" disabled={isLoading} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-wait">
                            {isLoading ? <SpinnerIcon className="animate-spin h-5 w-5" /> : 'Acceder'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
// --- FIN: Pantalla de Login ---


// --- INICIO: Componente Principal App ---
const App = ({ theme, setTheme }) => {
    const [currentDate, setCurrentDate] = useState(new Date(2025, 8, 1)); // Sept 2025
    
    const [people, setPeople] = useLocalStorage('shifter-people-v2', INITIAL_PEOPLE);
    const initialCalendars = {
      'principal': { id: 'principal', name: 'Principal', schedule: PRINCIPAL_SCHEDULE_DATA },
      'paseo_colon': { id: 'paseo_colon', name: 'Paseo Colon', schedule: PASEO_COLON_SCHEDULE },
    };
    const [calendars, setCalendars] = useLocalStorage('shifter-calendars-v2', initialCalendars);
    const [activeCalendarId, setActiveCalendarId] = useLocalStorage('shifter-active-calendar-v2', 'principal');
    const [activeView, setActiveView] = useLocalStorage('shifter-active-view-v2', 'calendar');

    const [modalState, setModalState] = useState({ isOpen: false, date: null, personIdToFocus: null });
    const [isPeopleManagerOpen, setIsPeopleManagerOpen] = useState(false);
    const [personToDelete, setPersonToDelete] = useState(null);
    const [addModePersonId, setAddModePersonId] = useState(null);
    const [clearDataModal, setClearDataModal] = useState({isOpen: false, target: null});
    const [isCapturing, setIsCapturing] = useState(false);
    
    const generalSchedule = useMemo(() => {
        const merged = {};
        Object.values(calendars).forEach(cal => {
            Object.entries(cal.schedule).forEach(([dateKey, assignments]) => {
                if (!merged[dateKey]) merged[dateKey] = [];
                const assignmentsWithCalName = assignments.map(a => ({...a, calendarName: cal.name}));
                merged[dateKey].push(...assignmentsWithCalName);
            });
        });
        return merged;
    }, [calendars]);

    const activeCalendar = calendars[activeCalendarId];
    const activeSchedule = activeCalendarId === GENERAL_CALENDAR_ID ? generalSchedule : activeCalendar?.schedule || {};

    const handleCapture = useCallback(() => {
        setIsCapturing(true);
        const captureElement = document.getElementById('capture-area');
        const fab = document.getElementById('fab-add-button');

        if (!captureElement) {
            console.error("Capture element not found");
            setIsCapturing(false);
            return;
        }

        if (fab) fab.style.display = 'none';

        html2canvas(captureElement, {
            useCORS: true,
            scale: 2,
            backgroundColor: theme === 'dark' ? '#030712' : '#f9fafb',
        }).then(canvas => {
            const link = document.createElement('a');
            const monthName = MONTH_NAMES[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            link.download = `calendario-${monthName.toLowerCase().replace(' ', '-')}-${year}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            console.error("Error capturing image:", err);
            alert("Hubo un error al generar la imagen.");
        }).finally(() => {
            if (fab) fab.style.display = 'flex';
            setIsCapturing(false);
        });
    }, [currentDate, theme]);

    const handleSaveAssignments = useCallback((dateKey, newAssignments) => {
        if (activeCalendarId === GENERAL_CALENDAR_ID) return;
        setCalendars(prev => ({
            ...prev,
            [activeCalendarId]: {
                ...prev[activeCalendarId],
                schedule: { ...prev[activeCalendarId].schedule, [dateKey]: newAssignments.length > 0 ? newAssignments : undefined }
            }
        }));
    }, [activeCalendarId, setCalendars]);

    const handleDayClick = useCallback((date) => {
        if (addModePersonId) {
            const dateKey = getDayKey(date);
            const newAssignment = { id: uid(), personId: addModePersonId };
            const currentAssignments = activeSchedule[dateKey] || [];
            if (currentAssignments.some(a => a.personId === addModePersonId)) return;
            handleSaveAssignments(dateKey, [...currentAssignments, newAssignment]);
        } else {
             setModalState({ isOpen: true, date });
        }
    }, [addModePersonId, activeSchedule, handleSaveAssignments]);

    const handleAddPerson = useCallback((newPerson) => {
        setPeople(prev => [...prev, { ...newPerson, id: uid() }]);
    }, [setPeople]);

    const handleUpdatePerson = useCallback((updatedPerson) => {
        setPeople(prev => prev.map(p => p.id === updatedPerson.id ? updatedPerson : p));
    }, [setPeople]);

    const handleConfirmDeletePerson = useCallback(() => {
        if (!personToDelete) return;
        const personIdToDelete = personToDelete.id;
        setPeople(prev => prev.filter(p => p.id !== personIdToDelete));
        setCalendars(prev => {
            const newCalendars = { ...prev };
            Object.keys(newCalendars).forEach(calId => {
                const newSchedule = {};
                Object.entries(newCalendars[calId].schedule).forEach(([dateKey, assignments]) => {
                    const filtered = assignments.filter(a => a.personId !== personIdToDelete);
                    if (filtered.length > 0) newSchedule[dateKey] = filtered;
                });
                newCalendars[calId].schedule = newSchedule;
            });
            return newCalendars;
        });
        setPersonToDelete(null);
    }, [personToDelete, setPeople, setCalendars]);

    const handleAddCalendar = () => {
        const newId = `cal-${uid()}`;
        const newName = `Calendario ${Object.keys(calendars).length + 1}`;
        setCalendars(prev => ({ ...prev, [newId]: { id: newId, name: newName, schedule: {} } }));
        setActiveCalendarId(newId);
    };

    const handleRenameCalendar = (id, newName) => {
        setCalendars(prev => ({ ...prev, [id]: { ...prev[id], name: newName } }));
    };
    
    const handleDeleteCalendar = (id) => {
        if (window.confirm(`¿Seguro que quieres borrar este calendario?`)) {
            setCalendars(prev => {
                const newCals = { ...prev };
                delete newCals[id];
                return newCals;
            });
            setActiveCalendarId(GENERAL_CALENDAR_ID);
        }
    };
    
    const handleConfirmClearData = () => {
        if(clearDataModal.target === 'all'){
            setPeople(INITIAL_PEOPLE);
            setCalendars(initialCalendars);
            setActiveCalendarId('principal');
        } else if(clearDataModal.target === 'assignments') {
             setCalendars(prev => {
                const clearedCals = {};
                Object.entries(prev).forEach(([id, cal]) => {
                    clearedCals[id] = {...cal, schedule: {}};
                });
                return clearedCals;
            });
        }
        setClearDataModal({isOpen: false, target: null});
    };
    
    return (
        <div className="min-h-screen bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-200 flex flex-col transition-colors duration-300">
            <Header 
                currentDate={currentDate} 
                theme={theme}
                onToggleTheme={() => setTheme(t => t === 'light' ? 'dark' : 'light')}
                onPrevMonth={() => setCurrentDate(d => new Date(d.getFullYear(), d.getMonth() - 1, 1))}
                onNextMonth={() => setCurrentDate(d => new Date(d.getFullYear(), d.getMonth() + 1, 1))}
                onGoToToday={() => setCurrentDate(new Date())}
                onOpenPeopleManager={() => setIsPeopleManagerOpen(true)}
                onClearData={() => setClearDataModal({isOpen: true, target: 'all'})}
                onCapture={handleCapture}
                isCapturing={isCapturing}
            />
            <Tabs 
                calendars={calendars}
                activeCalendarId={activeCalendarId}
                onSelectTab={setActiveCalendarId}
                onAddTab={handleAddCalendar}
                onRenameTab={handleRenameCalendar}
                onDeleteTab={handleDeleteCalendar}
            />

            <ViewSwitcher activeView={activeView} onSwitch={setActiveView} />
            
             {addModePersonId && activeCalendarId !== GENERAL_CALENDAR_ID && activeView === 'calendar' && (
                <div className="bg-green-100 dark:bg-green-900/50 border-b-2 border-green-300 dark:border-green-700 p-2 text-center sticky top-[161px] z-10">
                    <span className="font-semibold text-green-800 dark:text-green-200">Modo Añadir: Haz clic en el calendario para asignar.</span>
                    <button onClick={() => setAddModePersonId(null)} className="ml-4 text-green-600 dark:text-green-300 hover:text-green-800 dark:hover:text-green-100 font-bold">Cancelar</button>
                </div>
            )}
            
             {addModePersonId && activeCalendarId !== GENERAL_CALENDAR_ID && activeView === 'summary' && (
                <div className="bg-green-100 dark:bg-green-900/50 border-b-2 border-green-300 dark:border-green-700 p-2 text-center sticky top-[161px] z-10">
                    <span className="font-semibold text-green-800 dark:text-green-200">Modo Añadir activo. Cambia a la vista de Calendario para asignar turnos.</span>
                    <button onClick={() => setAddModePersonId(null)} className="ml-4 text-green-600 dark:text-green-300 hover:text-green-800 dark:hover:text-green-100 font-bold">Cancelar</button>
                </div>
            )}

            <main id="capture-area" className="container mx-auto max-w-7xl flex-grow w-full">
                 {activeView === 'calendar' ? (
                    <CalendarGrid
                        currentDate={currentDate} schedule={activeSchedule} people={people}
                        onDayClick={handleDayClick}
                        addModePersonId={addModePersonId}
                        activeCalendarId={activeCalendarId}
                        calendarName={activeCalendar?.name}
                    />
                ) : (
                     <SummaryView
                        schedule={activeSchedule} people={people} currentDate={currentDate}
                        onDayClick={(date, personId) => setModalState({ isOpen: true, date, personIdToFocus: personId })}
                        addModePersonId={addModePersonId}
                        onToggleAddMode={(personId) => setAddModePersonId(prev => prev === personId ? null : personId)}
                        activeCalendarId={activeCalendarId}
                    />
                )}
            </main>

            {activeCalendarId !== GENERAL_CALENDAR_ID && (
                <button id="fab-add-button" onClick={() => setModalState({ isOpen: true, date: new Date() })} className="fixed bottom-6 right-6 bg-blue-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 ring-blue-500" aria-label="Añadir turno"><PlusIcon className="w-8 h-8"/></button>
            )}

            <AssignmentModal
                isOpen={modalState.isOpen && activeCalendarId !== GENERAL_CALENDAR_ID}
                onClose={() => setModalState({ isOpen: false, date: null })}
                date={modalState.date}
                assignments={modalState.date ? (activeSchedule[getDayKey(modalState.date)] || []) : []}
                onSave={handleSaveAssignments}
                people={people}
                personIdToFocus={modalState.personIdToFocus}
                calendarName={activeCalendar?.name}
            />
            <PeopleManagementModal
                isOpen={isPeopleManagerOpen} onClose={() => setIsPeopleManagerOpen(false)}
                people={people} onAdd={handleAddPerson} onUpdate={handleUpdatePerson}
                onDelete={(person) => setPersonToDelete(person)}
            />
            <ConfirmationModal
                isOpen={!!personToDelete} onClose={() => setPersonToDelete(null)} onConfirm={handleConfirmDeletePerson}
                title={`Borrar a "${personToDelete?.name}"`} confirmText="Sí, borrar">
                <p>Se borrarán todos los turnos asignados a esta persona del calendario.</p>
                <p className="font-bold text-red-600 dark:text-red-400 mt-2">Esta acción no se puede deshacer.</p>
            </ConfirmationModal>
            <ConfirmationModal
                isOpen={clearDataModal.isOpen} onClose={() => setClearDataModal({isOpen: false, target: null})} onConfirm={handleConfirmClearData}
                title="Borrar Datos" confirmText="Sí, borrar todo">
                 <p>¿Estás seguro de que quieres borrar todos los datos de la aplicación y volver al estado inicial?</p>
                 <p className="font-bold text-red-600 dark:text-red-400 mt-2">Esta acción no se puede deshacer.</p>
            </ConfirmationModal>
        </div>
    );
};
// --- FIN: Componente Principal App ---


// --- INICIO: Componente de Autenticación ---
const AuthenticatedApp = () => {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [theme, setTheme] = useLocalStorage('shifter-theme-v2', 'light');

    useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
    }, [theme]);
    
    useEffect(() => {
        if (sessionStorage.getItem('shifter-is-authenticated') === 'true') {
            setIsAuthenticated(true);
        }
    }, []);

    const handleLoginSuccess = () => {
        sessionStorage.setItem('shifter-is-authenticated', 'true');
        setIsAuthenticated(true);
    };

    if (!isAuthenticated) {
        return <LoginScreen onLogin={handleLoginSuccess} />;
    }

    return <App theme={theme} setTheme={setTheme} />;
};
// --- FIN: Componente de Autenticación ---

// --- INICIO: Renderizar la aplicación ---
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<AuthenticatedApp />);
// --- FIN: Renderizar la aplicación ---
    </script>
</body>
</html>